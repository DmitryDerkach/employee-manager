name: Java CI with Maven & Docker

# КОГДА запускать этот "Листочек с заданиями"?
on:
  push:
    branches: [ "master", "master", "pipe-check"]
  pull_request:
    branches: [ "master", "master", "pipe-check"]
  workflow_dispatch:

# --- ВСТАВКА НАЧАЛО ---
# Разрешаем пайплайну писать в репозиторий (нужно для публикации отчета)
permissions:
  contents: write
  pages: write
  id-token: write
  issues: write
# --- ВСТАВКА КОНЕЦ ---

jobs:
  build-and-test:
    # ГДЕ запускать? (На чистом виртуальном компьютере Ubuntu)
    runs-on: ubuntu-latest

    steps:
      # 1. Скачиваем твой код на машину Runner'а
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Устанавливаем Java 8 (как у тебя локально)
      - name: Set up JDK 8
        uses: actions/setup-java@v3
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: 'maven' # Кэшируем библиотеки, чтобы не качать интернет каждый раз

      # 3. Проверка стиля (Checkstyle)
      # Если тут будет ошибка, пайплайн упадет СРАЗУ (Fail Fast).
      # Мы не тратим время на сборку и Docker, если код кривой.
      - name: Run Checkstyle
        run: mvn checkstyle:check
      # --- ИЗМЕНЕНИЯ НАЧИНАЮТСЯ ЗДЕСЬ ---

      # 4.1. Сначала запускаем тесты (и делаем clean здесь)
      # Это создаст отчет Coverage в папке target
      - name: Run Unit Tests (for Coverage)
        run: mvn clean test -pl backend-app

      # 4.2. Сборка приложения (Build) - ЭТАП "ВЕРСТАК"
      # УБИРАЕМ слово 'clean', чтобы не удалить отчет от предыдущего шага!
      # Оставляем -DskipTests, так как тесты мы уже прогнали выше.
      - name: Build Backend WAR
        run: mvn package -pl backend-app -am -DskipTests

      # --- ИЗМЕНЕНИЯ ЗАКОНЧИЛИСЬ ---

      # 5. Запуск окружения (Run) - ЭТАП "СЕЙФ"
      # Docker берет WAR файл, копирует его в контейнер и запускает Tomcat.
      - name: Start Docker Environment
        run: docker compose up -d --build --wait

      # 7. Тестирование - ЭТАП "ОБСТРЕЛ"
      - name: Run Tests (E2E & Integration)
        # Добавляем флаг headless для UI тестов
        run: mvn test -pl aqa-framework -Dselenide.headless=true

      # --- НАЧАЛО БЛОКА БЕЗОПАСНОСТИ OWASP ZAP ---
      - name: Run OWASP ZAP Security Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: 'http://localhost:8080/' # Атакуем наше запущенное приложение
          # Мы ставим fail_action в false. У ZAP очень строгие правила.
          # Если он найдет даже мелкую уязвимость, он "уронит" пайплайн.
          # Пока мы просто хотим получить красивый отчет, а не блокировать релиз.
          fail_action: false

      # --- ВСТАВКА НАЧАЛО: Переключаем Java для Сонара ---
      - name: Set up JDK 17 for Sonar
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      # --- ВСТАВКА КОНЕЦ ---

      # ВМЕСТО step "SonarCloud Scan" вставь это:
      - name: SonarCloud Scan (via Maven)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B sonar:sonar \
            -Dsonar.organization=dmitryderkach \
            -Dsonar.projectKey=DmitryDerkach_employee-manager \
            -Dsonar.host.url=https://sonarcloud.io       

      # 8. (DEBUG) Если что-то упало — покажи логи контейнеров!
      # Этот шаг выполнится, только если предыдущие шаги упали (if: failure())
      - name: Dump Docker Logs
        if: failure()
        run: docker compose logs
      # ... тут были тесты и docker logs ...

      # 9. Генерируем отчет и загружаем его в "историю" пайплайна
      - name: Load test report history
        uses: actions/checkout@v3
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Build Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          # Где искать результаты тестов (JSON)
          allure_results: aqa-framework/target/allure-results
          # Сохранять историю предыдущих прогонов? Да!
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history

      # 10. Публикуем отчет на GitHub Pages
      - name: Publish Allure Report
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

      # ... твои предыдущие шаги (тесты, Sonar, Allure и т.д.) ...

      # СОХРАНЯЕМ WAR-ФАЙЛ КАК АРТЕФАКТ
      - name: Upload WAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: employee-app-war # Название нашей "посылки"
          path: backend-app/target/employee-app.war # Что именно кладем в посылку
          retention-days: 1 # Хранить всего 1 день, чтобы не забивать память GitHub

    # ... тут заканчивается твоя джоба build-and-test ...

  # НАША НОВАЯ ДЖОБА ДЛЯ ДОКЕРА
  build-and-push-docker:
    needs: build-and-test # ⚠️ МАГИЯ ЗДЕСЬ! Ждем, пока первая джоба успешно завершится. Если тесты упадут - эта джоба отменится!
    runs-on: ubuntu-latest

    steps:
      # 1. Скачиваем Dockerfile из репозитория
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Скачиваем "посылку" с WAR-файлом от первой джобы!
      # Нам больше не нужны Java и Maven в этой виртуалке!
      - name: Download WAR artifact
        uses: actions/download-artifact@v4
        with:
          name: employee-app-war # Имя посылки должно совпадать
          path: backend-app/target/ # Кладем туда, где его будет искать Dockerfile

      # 3. Логинимся в Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. Собираем и пушим образ
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/employee-manager-app:latest