name: CI/CD Pipeline - Docker Hub Delivery

# 1. КОГДА запускать пайплайн?
# Запускаем при каждом пуше в основную ветку.
on:
  push:
    branches: ["master" ] # ⚠️ Оставь тут название своей главной ветки!

jobs:
  build-and-push:
    # 2. ГДЕ запускать? (на бесплатном сервере Ubuntu от GitHub)
    runs-on: ubuntu-latest

    steps:
      # Шаг 1: Скачиваем твой код из репозитория на сервер GitHub
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Шаг 2: Устанавливаем Java 8 (так как наш проект на старой доброй Java 8)
      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: maven # Кэшируем зависимости Maven, чтобы следующие сборки шли быстрее

      # Шаг 3: Собираем наш артефакт (.war)
      # Используем -DskipTests, чтобы сэкономить время (тесты у тебя гоняются в другом пайплайне)
      # Этот шаг КРИТИЧЕСКИ ВАЖЕН: без него Dockerfile не найдет файл employee-app.war!
      - name: Build WAR with Maven
        run: mvn clean package -DskipTests

      # Шаг 4: Логинимся в Docker Hub, используя те самые секреты
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Шаг 5: Собираем Docker-образ и пушим его в облако
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: . # Ищем Dockerfile и папку target в корне проекта
          push: true # Говорим "Да, отправь это в Docker Hub"
          # Формируем тег: твой_логин/название_репозитория:latest
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/employee-manager-app:latest